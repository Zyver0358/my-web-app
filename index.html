<!DOCTYPE html>
<html>
<head>
    <link rel="manifest" href="manifest.json">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
    <title>DBD 2D - Full Feature Build</title>
    <style>
    body { 
        margin: 0; 
        overflow: hidden; 
        background: #0a0a0a; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        height: 100vh; 
        width: 100vw;
        font-family: sans-serif; 
        touch-action: none; 
    }
    
    /* This makes the game container expand to fit the screen width */
    #game-container { 
        position: relative; 
        width: 100vw; 
        height: 100vh; 
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    canvas { 
        display: block; 
        /* This maintains aspect ratio while filling the screen */
        max-width: 100%; 
        max-height: 100%; 
        image-rendering: pixelated; 
    }

    .ui { position: fixed; top: 10px; left: 10px; color: white; z-index: 100; pointer-events: none; text-shadow: 2px 2px 2px black; font-size: 14px; }

    /* POSITION JOYSTICKS FOR LANDSCAPE */
    .joystick-container { 
        display: none; 
        position: fixed; 
        bottom: 20px; /* Brought closer to the bottom */
        left: 0;
        width: 100%; 
        justify-content: space-between; 
        padding: 0 40px; 
        box-sizing: border-box; 
        pointer-events: none; 
        z-index: 1000; 
    }

    @media (max-width: 1024px) { .joystick-container { display: flex; } }

    .joystick-base { 
        width: 100px; 
        height: 100px; 
        background: rgba(255, 255, 255, 0.1); 
        border: 2px solid rgba(255, 255, 255, 0.3); 
        border-radius: 50%; 
        position: relative; 
        pointer-events: auto; /* Buttons are clickable, container isn't */
    }

    .joystick-stick { width: 40px; height: 40px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; position: absolute; top: 30px; left: 30px; pointer-events: none; }
</style>
</head>
<body>

    <div class="ui">
        <span class="pc-controls"><b>WASD</b> to Move | <b>M1</b> to Attack</span>
        <span class="mobile-controls" style="display:none;">Use <b>Joysticks</b> to Move & Aim</span><br>
        <span id="status-text">Trial in Progress...</span>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div class="joystick-container" id="mobile-ui">
        <div id="move-joystick" class="joystick-base"><div class="joystick-stick"></div></div>
        <div id="aim-joystick" class="joystick-base"><div class="joystick-stick"></div></div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

// --- 1. WORLD & SCREEN SETUP ---
const world = { width: 3000, height: 3000 };
let screen = { width: window.innerWidth, height: window.innerHeight };

function setupCanvas() {
    const dpr = window.devicePixelRatio || 1;
    screen.width = window.innerWidth;
    screen.height = window.innerHeight;

    canvas.width = screen.width * dpr;
    canvas.height = screen.height * dpr;
    canvas.style.width = screen.width + "px";
    canvas.style.height = screen.height + "px";

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.imageSmoothingEnabled = false;
}
window.addEventListener('resize', setupCanvas);
setupCanvas();

// --- 2. PLAYER & MAP DATA ---
const player = {
    x: world.width / 2, 
    y: world.height / 2,
    w: 50, h: 100, 
    speed: 7, 
    angle: 0
};

const mapObjects = [
    { x: 1200, y: 1200, w: 200, h: 70, color: "#444", solid: true },
    { x: 1400, y: 1100, w: 85, h: 85, color: "#555", solid: true },
    { x: 1550, y: 1450, w: 30, h: 50, color: "#ff4500", solid: true },
    { x: 2000, y: 2000, w: 40, h: 60, color: '#e67e22', solid: true }
];

// --- 3. INPUT HANDLING ---
const keys = {};
const joyInput = { x: 0, y: 0 };
window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

function setupJoystick(id) {
    const base = document.getElementById(id);
    const stick = base.querySelector('.joystick-stick');
    const limit = 40;
    let touchId = null;

    base.addEventListener("touchstart", e => {
        e.preventDefault();
        touchId = e.changedTouches[0].identifier;
    }, { passive: false });

    document.addEventListener("touchmove", e => {
        if (touchId === null) return;
        for (let t of e.touches) {
            if (t.identifier === touchId) {
                const rect = base.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                let dx = t.clientX - cx;
                let dy = t.clientY - cy;
                const dist = Math.hypot(dx, dy);
                if (dist > limit) { dx *= limit/dist; dy *= limit/dist; }
                stick.style.transform = `translate(${dx}px, ${dy}px)`;
                joyInput.x = dx / limit;
                joyInput.y = dy / limit;
            }
        }
    }, { passive: false });

    document.addEventListener("touchend", e => {
        for (let t of e.changedTouches) {
            if (t.identifier === touchId) {
                touchId = null;
                stick.style.transform = `translate(0,0)`;
                joyInput.x = 0; joyInput.y = 0;
            }
        }
    });
}
if (isMobile) setupJoystick('move-joystick');

// --- 4. GAME ENGINE ---
function update() {
    let moveX = joyInput.x, moveY = joyInput.y;
    if (keys['w']) moveY = -1; if (keys['s']) moveY = 1;
    if (keys['a']) moveX = -1; if (keys['d']) moveX = 1;

    // Movement logic
    if (Math.abs(moveX) > 0.1 || Math.abs(moveY) > 0.1) {
        player.x += moveX * player.speed;
        player.y += moveY * player.speed;
    }
}

function draw() {
    ctx.clearRect(0, 0, screen.width, screen.height);
    ctx.save();
    
    // Camera follow
    ctx.translate(screen.width/2 - player.x, screen.height/2 - player.y);

    // Draw Grass/Floor
    ctx.fillStyle = "#1a211a";
    ctx.fillRect(0, 0, world.width, world.height);

    // Draw Objects
    mapObjects.forEach(obj => {
        ctx.fillStyle = obj.color;
        ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
    });

    // Draw Player (Killer)
    ctx.fillStyle = "red";
    ctx.fillRect(player.x - 25, player.y - 50, 50, 100);

    ctx.restore();
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}
gameLoop();
</script>
</body>
</html>
